<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Intervalli Squadra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Librerie PDF (Motore Admin) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <script type="module" src="../auth-manager.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #E2E8F0;
            -webkit-font-smoothing: antialiased;
        }
        .background-gradient {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            filter: blur(100px); z-index: -1;
        }
        .gradient-1 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.3), transparent 70%);
            animation: pulse 10s infinite alternate;
        }
        .gradient-2 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.2), transparent 70%);
            animation: pulse 12s infinite alternate-reverse;
        }
        @keyframes pulse {
            0% { transform: scale(0.9) rotate(0deg); }
            100% { transform: scale(1.2) rotate(20deg); }
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .stat-label { font-size: 0.65rem; text-transform: uppercase; color: #94A3B8; letter-spacing: 0.05em; font-weight: 600; }
        .stat-value { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-weight: 700; color: #F8FAFC; font-size: 1.1rem; }
        .stat-sub { font-size: 0.75rem; color: #64748B; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .card-header { border-bottom: 1px solid rgba(148, 163, 184, 0.1); padding-bottom: 0.5rem; margin-bottom: 0.75rem; }
    </style>
</head>
<body class="antialiased min-h-screen">

    <div class="background-gradient gradient-1"></div>
    <div class="background-gradient gradient-2"></div>

    <!-- Canvas Nascosto per PDF alta risoluzione -->
    <div style="position: absolute; left: -9999px; top: -9999px;">
        <canvas id="hiddenPdfCanvas" width="1600" height="800"></canvas>
    </div>

    <div class="p-4 md:p-8 max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl md:text-4xl font-black tracking-tight text-slate-100">Grafici & Analisi</h1>
            <a href="home_carica_dati.html" class="p-2 bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors shadow-lg border border-slate-700">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
            </a>
        </div>

        <p class="text-md text-slate-400 text-center mb-8">Inserisci i dati degli intervalli per generare grafici e statistiche dettagliate.</p>

        <div class="bg-slate-800/70 border border-slate-700/50 rounded-xl p-4 mb-6 shadow-xl backdrop-blur-sm grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <label for="boat-selector" class="block text-sm font-medium text-slate-300 mb-1">Barca</label>
                <select id="boat-selector" onchange="handleSelectionChange()" class="w-full p-2 bg-slate-700/70 border border-slate-600 rounded-lg text-white font-semibold focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="" disabled selected>Seleziona</option>
                    </select>
            </div>
            
            <div>
                <label for="crew-names" class="block text-sm font-medium text-slate-300 mb-1">Equipaggio</label>
                <input type="text" id="crew-names" oninput="checkGenerationReadiness()" class="w-full p-2 bg-slate-700/70 border border-slate-600 rounded-lg text-white font-semibold focus:ring-2 focus:ring-blue-500 outline-none placeholder-slate-500" placeholder="Es. Rossi, Bianchi...">
            </div>

            <div id="distance-wrapper" class="hidden">
                <label for="distance-selector" class="block text-sm font-medium text-slate-300 mb-1">Distanza (m)</label>
                <select id="distance-selector" onchange="handleSelectionChange()" class="w-full p-2 bg-slate-700/70 border border-slate-600 rounded-lg text-white font-semibold focus:ring-2 focus:ring-blue-500 outline-none">
                    </select>
            </div>

            <div id="runs-wrapper" class="hidden">
                <label for="runs-selector" class="block text-sm font-medium text-slate-300 mb-1">N. Ripetute</label>
                <select id="runs-selector" onchange="handleSelectionChange()" class="w-full p-2 bg-slate-700/70 border border-slate-600 rounded-lg text-white font-semibold focus:ring-2 focus:ring-blue-500 outline-none">
                    </select>
            </div>
        </div>

        <div id="input-runs-container" class="space-y-6">
            <div class="p-6 text-center text-slate-400 bg-slate-800/50 border border-slate-700/50 rounded-xl">
                Seleziona Barca, Distanza e Numero Intervalli per iniziare.
            </div>
        </div>
        
        <div class="mt-8 flex flex-col md:flex-row justify-center items-center gap-4">
            <button id="generate-chart-btn" onclick="generateChartAndSaveData(true)" disabled class="w-full md:w-auto px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-xl transition-colors disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                Genera & Salva
            </button>
            
            <button id="openHistoryBtn" class="w-full md:w-auto px-8 py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-lg shadow-xl transition-colors flex items-center justify-center border border-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 3v18h18"/><path d="M12 8v4l3 3"/></svg>
                Storico Salvataggi
            </button>

            <button id="download-data-btn" onclick="downloadPdf()" disabled class="w-full md:w-auto px-8 py-3 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded-lg shadow-xl transition-colors disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Scarica PDF
            </button>
        </div>
        
        <div id="speed-chart-container" class="mt-8 bg-slate-800/70 border border-slate-700/50 rounded-xl p-4 md:p-6 shadow-xl backdrop-blur-sm hidden">
            <h2 class="text-xl font-bold text-slate-100 mb-4">Grafico 1: Velocità (m/s)</h2>
            <div class="h-64 md:h-96"><canvas id="performanceChartSpeed"></canvas></div>
        </div>

        <div id="sr-chart-container" class="mt-8 bg-slate-800/70 border border-slate-700/50 rounded-xl p-4 md:p-6 shadow-xl backdrop-blur-sm hidden">
            <h2 class="text-xl font-bold text-slate-100 mb-4">Grafico 2: Colpi (SR)</h2>
            <div class="h-64 md:h-96"><canvas id="performanceChartSR"></canvas></div>
        </div>

        <div id="summary-legend-container" class="mt-8 bg-slate-800/70 border border-slate-700/50 rounded-xl p-4 md:p-6 hidden">
            <h2 class="text-xl font-bold text-slate-100 mb-4">Riepilogo Prestazioni</h2>
            
            <div id="global-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"></div>

            <h3 class="text-lg font-bold text-slate-200 mb-3 border-t border-slate-700 pt-4">Dettaglio Intervalli</h3>
            <div id="run-summary-list" class="space-y-4"></div>
        </div>

        <div id="messageBox" class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center hidden backdrop-blur-sm">
            <div class="bg-slate-800 border border-slate-700 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
                <h3 id="messageBoxTitle" class="text-lg font-bold text-slate-100 mb-3">Messaggio</h3>
                <p id="messageBoxContent" class="text-slate-300 mb-6"></p>
                <button id="messageBoxOkBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition-colors">OK</button>
            </div>
        </div>

        <div id="historyModal" class="fixed inset-0 bg-slate-900/90 z-[150] flex items-center justify-center hidden backdrop-blur-sm">
            <div class="bg-slate-800 border border-slate-700 w-full max-w-2xl h-[80vh] rounded-2xl shadow-2xl flex flex-col m-4">
                <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-800 rounded-t-2xl">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <svg class="w-6 h-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        I Miei Allenamenti
                    </h3>
                    <button id="closeHistoryBtn" class="text-slate-400 hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                
                <div id="historyListContainer" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                    <p class="text-center text-slate-500 mt-10">Caricamento storico...</p>
                </div>
            </div>
        </div>
        
    </div>

    <script type="module">
        // Importazioni da Auth Manager e Firestore
        import { db, auth } from '../auth-manager.js';
        import { collection, addDoc, serverTimestamp, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- CONFIGURAZIONE ---
        const AVAILABLE_DISTANCES = [500, 750, 1000, 1500, 2000];
        const MAX_RUNS = 10;
        const SEGMENT_DISTANCE = 100;
        const PACE_REFERENCE_DISTANCE = 500;
        const COLORS = ['#4ADE80', '#0EA5E9', '#F472B6', '#FACC15', '#A78BFA', '#FB923C', '#E11D48', '#14B8A6', '#64748B', '#A3E635'];
        const SR_POINT_MAX_COLOR = '#FACC15'; 
        const SR_POINT_MIN_COLOR = '#E11D48';
        const BOATS = ['ROWERG', 'M1X', 'M2X', 'M4X', 'M2-', 'M4-', 'M8+', 'W1X', 'W2X', 'W4X', 'W2-', 'W4-', 'W8+'];

        let chartInstanceSpeed, chartInstanceSR, hiddenChartInstance;
        let selectedDistance = 2000; 
        let selectedRuns = 1;
        let currentDataCache = null; // Cache dati attuali (input o storico)
        let historyCache = null; // Cache lista storico (per risparmio letture)

        // --- UTILITY ---
        const showMessageBox = (title, message) => {
            document.getElementById('messageBoxTitle').textContent = title;
            document.getElementById('messageBoxContent').textContent = message;
            document.getElementById('messageBox').classList.remove('hidden');
        };

        const toPace = (mps) => {
            if (!mps || mps <= 0) return "-";
            const totalSeconds = 500 / mps;
            const m = Math.floor(totalSeconds / 60);
            const s = (totalSeconds % 60).toFixed(1).padStart(4, '0');
            return `${m}:${s}`;
        };

        function parseTimeStringToSeconds(str) {
            if (!str) return 0;
            const parts = str.split(':');
            if (parts.length === 2) return parseInt(parts[0]) * 60 + parseFloat(parts[1]);
            return parseFloat(str) || 0;
        }

        // Funzione helper mancante per il PDF (converte secondi in formato mm:ss.d)
        function secondsToPaceString(s) {
            if (!isFinite(s) || s <= 0) return '-';
            const m = Math.floor(s / 60);
            const sec = (s % 60).toFixed(1).padStart(4, '0');
            return `${m}:${sec}`;
        }

        // --- CURVA DI GARLAND (Ideale) - LOGICA ADMIN/PUBLIC ---
        function getIdealCurvePoints(globalAvg, maxDistance, boatType) {
            const points = [];
            const isRowerg = boatType && (boatType.toUpperCase().includes("ROWERG") || boatType.toUpperCase().includes("ERG"));
            
            let pStart, p2, p3, p4;
            if(isRowerg) { pStart = 1.015; p2 = 0.998; p3 = 0.990; p4 = 0.997; } 
            else { pStart = 1.033; p2 = 0.990; p3 = 0.983; p4 = 0.997; }

            // CORREZIONE ADMIN: Picco iniziale è moltiplicato per 1.12 per garantire START > FINISH
            const peakVal = globalAvg * pStart * 1.12;
            
            points.push({x: 0, y: 0});
            if (maxDistance >= 50) points.push({x: 50, y: peakVal * 0.7});
            if (maxDistance >= 100) points.push({x: 100, y: peakVal * 0.95});
            if (maxDistance >= 200) points.push({x: 200, y: peakVal}); // PICCO FISSO A 200m

            if (maxDistance > 200) {
                if (maxDistance >= 400) points.push({x: 350, y: globalAvg * pStart}); 
                if (maxDistance >= 1500) {
                     points.push({x: 750, y: globalAvg * p2});
                     points.push({x: 1250, y: globalAvg * p3});
                     points.push({x: maxDistance - 250, y: globalAvg * (p3 + p4)/2});
                } else if (maxDistance >= 1000) {
                     points.push({x: maxDistance * 0.4, y: globalAvg * p2});
                     points.push({x: maxDistance * 0.7, y: globalAvg * p3});
                } 
                const kickStart = maxDistance - 100;
                if (kickStart > 200) points.push({x: kickStart, y: globalAvg * 1.05});
                points.push({x: maxDistance, y: globalAvg * 1.10});
            }
            return points.sort((a,b) => a.x - b.x);
        }

        // --- CALCOLO STATISTICHE TECNICHE ---
        function calculateTechnicalStats(speedPoints, srPoints, distance, timeSeconds) {
            const speeds = speedPoints ? speedPoints.map(p => p.y).filter(y => y > 0) : [];
            const srs = srPoints ? srPoints.map(p => p.y).filter(y => y > 0) : [];

            const maxSpeed = speeds.length ? Math.max(...speeds) : 0;
            const minSpeed = speeds.length ? Math.min(...speeds) : 0;
            const avgSpeed = (distance && timeSeconds) ? (distance/timeSeconds) : (speeds.length ? speeds.reduce((a,b)=>a+b,0)/speeds.length : 0);

            const maxSr = srs.length ? Math.max(...srs) : 0;
            const minSr = srs.length ? Math.min(...srs) : 0;
            const avgSr = srs.length ? srs.reduce((a,b)=>a+b,0)/srs.length : 0;

            const wattPoints = speeds.map(v => 2.8 * Math.pow(v, 3));
            const maxWatt = wattPoints.length ? Math.max(...wattPoints) : 0;
            const minWatt = wattPoints.length ? Math.min(...wattPoints) : 0;
            const avgWatt = 2.8 * Math.pow(avgSpeed, 3);

            return { maxSpeed, minSpeed, avgSpeed, maxSr, minSr, avgSr, maxWatt, minWatt, avgWatt };
        }

        // --- SALVATAGGIO DATI ---
        async function saveRunData(dataToSave) {
            const saveButton = document.getElementById('generate-chart-btn');
            saveButton.disabled = true;
            saveButton.textContent = "Salvataggio...";

            try {
                await addDoc(collection(db, "graphics"), dataToSave);
                historyCache = null; // Reset cache
                showMessageBox("Successo!", `Allenamento salvato correttamente.`);
                saveButton.textContent = "Genera & Salva";
                document.getElementById('download-data-btn').disabled = false;
                currentDataCache = dataToSave.runs; 
            } catch (error) {
                console.error("Errore save:", error);
                showMessageBox("Errore", `Impossibile salvare: ${error.message}`);
                saveButton.disabled = false;
                saveButton.textContent = "Genera & Salva";
            }
        }
        
        // --- GESTIONE STORICO ---
        async function openHistoryModal() {
            const modal = document.getElementById('historyModal');
            const list = document.getElementById('historyListContainer');
            modal.classList.remove('hidden');
            
            if (!auth.currentUser) {
                list.innerHTML = '<p class="text-center text-red-400 mt-10">Devi essere loggato.</p>';
                return;
            }

            if (historyCache) {
                renderHistoryList(historyCache);
                return;
            }

            try {
                list.innerHTML = '<div class="text-center mt-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto"></div><p class="text-slate-400 mt-2">Caricamento...</p></div>';
                const q = query(
                    collection(db, "graphics"), 
                    where("uid", "==", auth.currentUser.uid), 
                    orderBy("timestamp", "desc"),
                    limit(20) 
                );
                
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    list.innerHTML = '<p class="text-center text-slate-500 mt-10">Nessun allenamento salvato.</p>';
                    return;
                }

                historyCache = [];
                querySnapshot.forEach(doc => {
                    historyCache.push({ id: doc.id, data: doc.data() });
                });
                renderHistoryList(historyCache);

            } catch (error) {
                console.error("Errore storico:", error);
                list.innerHTML = `<p class="text-center text-red-400 mt-10">Errore nel caricamento.</p>`;
            }
        }

        function renderHistoryList(items) {
            const list = document.getElementById('historyListContainer');
            let html = '';
            items.forEach(item => {
                const data = item.data;
                const dateObj = data.timestamp ? data.timestamp.toDate() : new Date();
                const dateStr = dateObj.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
                const timeStr = dateObj.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                const safeData = encodeURIComponent(JSON.stringify(data));

                html += `
                    <div onclick="restoreSessionFromData('${safeData}')" class="bg-slate-700/40 hover:bg-slate-700 border border-slate-600/50 hover:border-indigo-500/50 p-4 rounded-xl cursor-pointer transition-all group">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-bold bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded">${data.boat || '?'}</span>
                                    <span class="text-slate-400 text-xs">${dateStr}, ${timeStr}</span>
                                </div>
                                <h4 class="font-bold text-slate-200 group-hover:text-white">${data.crewString || 'Sconosciuto'}</h4>
                                <p class="text-xs text-slate-400 mt-1">${data.runsCount || (data.runs ? data.runs.length : '-')}x${data.distance}m</p>
                            </div>
                            <svg class="w-5 h-5 text-indigo-400 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </div>
                    </div>`;
            });
            list.innerHTML = html;
        }

        window.restoreSessionFromData = (encodedJson) => {
            try {
                const data = JSON.parse(decodeURIComponent(encodedJson));
                if(document.getElementById('boat-selector')) document.getElementById('boat-selector').value = data.boat;
                if(document.getElementById('crew-names')) document.getElementById('crew-names').value = data.crewString;
                
                selectedDistance = parseInt(data.distance);
                selectedRuns = parseInt(data.runsCount || data.runs.length);
                currentDataCache = data.runs; 

                document.getElementById('speed-chart-container').classList.remove('hidden');
                document.getElementById('sr-chart-container').classList.remove('hidden');
                document.getElementById('summary-legend-container').classList.remove('hidden');
                
                updateCharts(data.runs);
                updateSummary(data.runs);
                document.getElementById('download-data-btn').disabled = false;

                document.getElementById('historyModal').classList.add('hidden');
                showMessageBox("Caricato", "Dati recuperati dallo storico.");
            } catch (e) {
                console.error(e);
                showMessageBox("Errore", "Impossibile ripristinare i dati.");
            }
        };

        // --- UI GESTIONE ---
        function renderBoatSelector() {
            const sel = document.getElementById('boat-selector');
            sel.innerHTML = '<option value="" disabled selected>Seleziona Barca</option>';
            BOATS.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b; opt.textContent = b; sel.appendChild(opt);
            });
            renderDistanceSelector();
            renderRunsSelector();
        }

        function renderDistanceSelector() {
            const sel = document.getElementById('distance-selector');
            sel.innerHTML = '';
            AVAILABLE_DISTANCES.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d; opt.textContent = `${d} metri`;
                if(d === selectedDistance) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function renderRunsSelector() {
            const sel = document.getElementById('runs-selector');
            sel.innerHTML = '';
            for (let i = 1; i <= MAX_RUNS; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = i;
                if(i === selectedRuns) opt.selected = true;
                sel.appendChild(opt);
            }
        }
        
        window.handleSelectionChange = () => {
            selectedDistance = parseInt(document.getElementById('distance-selector').value);
            selectedRuns = parseInt(document.getElementById('runs-selector').value);
            currentDataCache = null; 
            
            if(document.getElementById('boat-selector').value) {
                document.getElementById('distance-wrapper').classList.remove('hidden');
                document.getElementById('runs-wrapper').classList.remove('hidden');
                renderInputs();
            }
            document.getElementById('speed-chart-container').classList.add('hidden');
            document.getElementById('sr-chart-container').classList.add('hidden');
            document.getElementById('summary-legend-container').classList.add('hidden');
            document.getElementById('download-data-btn').disabled = true;
            checkGenerationReadiness();
        };

        window.checkGenerationReadiness = () => {
            const boatSelected = document.getElementById('boat-selector').value !== '';
            const crewFilled = document.getElementById('crew-names').value.trim() !== '';
            const inputsRendered = document.getElementById('input-runs-container').querySelectorAll('.pace-input').length > 0;
            document.getElementById('generate-chart-btn').disabled = !(crewFilled && inputsRendered && boatSelected);
        };

        // --- FORMATTAZIONE INPUT ---
        window.formatPaceInput = (event) => {
            const input = event.target;
            let d = input.value.replace(/[^0-9]/g, ''); 
            if (d.length > 6) d = d.substring(0, 6);
            let val = '';
            if (d.length >= 1) {
                const dec = d.slice(-1); 
                let ss = d.slice(-3, -1);
                let m = d.slice(0, -3);
                if (ss.length === 2 && parseInt(ss) > 59) ss = '59';
                if (m) val = `${parseInt(m)}:${ss.padStart(2,'0')}.${dec}`;
                else if (ss.length === 2) val = `0:${ss}.${dec}`;
                else if (ss.length === 1) val = `0:0${ss}.${dec}`;
                else val = `0:00.${dec}`;
            }
            input.value = val;
            currentDataCache = null; 
        };

        window.formatSrInput = (event) => {
            const input = event.target;
            let d = input.value.replace(/[^0-9]/g, '');
            if (d.length > 3) d = d.substring(0, 3);
            let val = '';
            if (d.length === 3) val = `${d.substring(0,2)}.${d.substring(2)}`;
            else val = d;
            input.value = val;
            currentDataCache = null; 
        };

        function paceToSeconds(p) {
            if (!p) return 0;
            p = p.trim().replace(',', '.');
            const parts = p.split(':');
            if (parts.length === 2) {
                return (parseInt(parts[0])*60) + parseFloat(parts[1]);
            }
            return parseFloat(p) || 0;
        }

        function renderInputs() {
            const container = document.getElementById('input-runs-container');
            container.innerHTML = ''; 
            if (!document.getElementById('boat-selector').value) return;
            const numSegments = selectedDistance / SEGMENT_DISTANCE;

            for (let i = 1; i <= selectedRuns; i++) {
                const runId = i, runColor = COLORS[i - 1];
                let tableRows = '';
                for (let j = 1; j <= numSegments; j++) {
                    const dist = j * SEGMENT_DISTANCE;
                    tableRows += `
                        <tr class="hover:bg-slate-800/50 transition-colors border-b border-slate-700/50 last:border-0">
                            <td class="py-2 px-3 text-sm font-medium text-slate-400">${dist}</td>
                            <td class="py-2 px-3 text-center">
                                <input type="text" class="pace-input w-full md:w-24 p-1 text-center bg-slate-700/70 border border-slate-600 rounded text-sm text-white font-mono focus:border-blue-500 outline-none" placeholder="mm:ss.d" data-run-id="${runId}" data-distance="${dist}" oninput="formatPaceInput(event)" ${j === 1 ? `onpaste="handlePaste(event, ${runId})"` : ''} inputmode="decimal">
                            </td>
                            <td class="py-2 px-3 text-center">
                                <input type="text" class="sr-input w-full md:w-20 p-1 text-center bg-slate-700/70 border border-slate-600 rounded text-sm text-white font-mono focus:border-orange-500 outline-none" placeholder="nn.n" data-run-id="${runId}" data-distance="${dist}" oninput="formatSrInput(event)" inputmode="decimal">
                            </td>
                            <td id="speed-${runId}-${dist}" class="py-2 px-3 text-center text-sm text-emerald-400 font-mono">-</td>
                        </tr>`;
                }

                container.insertAdjacentHTML('beforeend', `
                    <div class="bg-slate-800/70 border border-slate-700/50 rounded-xl shadow-lg backdrop-blur-sm p-4 animate-fade-in">
                        <div class="flex items-center gap-3 mb-3">
                            <span style="background-color: ${runColor}; width: 12px; height: 12px; border-radius: 50%;"></span>
                            <h3 class="text-lg font-bold text-slate-100">Intervallo ${runId}</h3>
                        </div>
                        <div class="overflow-x-auto rounded-lg border border-slate-700/50">
                            <table class="min-w-full text-left">
                                <thead class="bg-slate-700/50 text-xs uppercase text-slate-400 font-semibold">
                                    <tr>
                                        <th class="py-2 px-3">Dist.</th>
                                        <th class="py-2 px-3 text-center">Passo</th>
                                        <th class="py-2 px-3 text-center">SR</th>
                                        <th class="py-2 px-3 text-center">m/s</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-700/50">${tableRows}</tbody>
                            </table>
                        </div>
                    </div>
                `);
            }
            checkGenerationReadiness();
        }

        window.handlePaste = (event, runId) => {
            event.preventDefault();
            const lines = event.clipboardData.getData('text').split(/[\n\r]+/).filter(s => s.trim().length > 0);
            const pInps = document.querySelectorAll(`.pace-input[data-run-id="${runId}"]`);
            const sInps = document.querySelectorAll(`.sr-input[data-run-id="${runId}"]`);
            lines.forEach((line, idx) => {
                const parts = line.split(/[\t\s]+/);
                if (pInps[idx] && parts[0]) { pInps[idx].value = parts[0].replace(/[^0-9.]/g, ''); formatPaceInput({target: pInps[idx]}); }
                if (sInps[idx] && parts[1]) { sInps[idx].value = parts[1].replace(/[^0-9.]/g, ''); formatSrInput({target: sInps[idx]}); }
            });
            currentDataCache = null;
        };

        function analyzeRunData(runId) {
            const speedDP = [], srDP = [];
            let totalSec = 0, valid = true, totalSr = 0, srCount = 0;
            const pInps = document.querySelectorAll(`.pace-input[data-run-id="${runId}"]`);
            const sInps = document.querySelectorAll(`.sr-input[data-run-id="${runId}"]`);
            if (pInps.length === 0) return null;

            pInps.forEach((inp, idx) => {
                const dist = parseInt(inp.dataset.distance);
                const secs = paceToSeconds(inp.value);
                const sr = parseFloat(sInps[idx].value);
                const disp = document.getElementById(`speed-${runId}-${dist}`);

                if (secs > 0) {
                    const spd = PACE_REFERENCE_DISTANCE / secs;
                    if(disp) disp.textContent = spd.toFixed(2);
                    speedDP.push({x: dist, y: parseFloat(spd.toFixed(3)), pace: secs});
                    totalSec += (secs * (SEGMENT_DISTANCE / PACE_REFERENCE_DISTANCE));
                } else { if(disp) disp.textContent = '-'; valid = false; }

                if (sr > 0) { srDP.push({x: dist, y: sr}); totalSr += sr; srCount++; } else { valid = false; }
            });

            if (!valid || speedDP.length === 0) return null;

            const avgSpd = selectedDistance / totalSec;
            const maxSpd = speedDP.reduce((m,p)=> p.y > m.y ? p : m, {y:-1});
            const minSpd = speedDP.reduce((m,p)=> p.y < m.y ? p : m, {y:999});
            const avgSr = totalSr / srCount;
            const maxSr = srDP.reduce((m,p)=> p.y > m.y ? p : m, {y:-1});
            const minSr = srDP.reduce((m,p)=> p.y < m.y ? p : m, {y:999});

            return {
                runId, color: COLORS[runId-1],
                totalSec, totalSeconds: totalSec,
                totalTimeStr: `${Math.floor(totalSec/60)}:${(totalSec%60).toFixed(1).padStart(4,'0')}`,
                speedData: speedDP, srData: srDP,
                avgSpd, maxSpd, minSpd,
                avgSr, maxSr, minSr, distance: selectedDistance
            };
        }

        window.updateAllData = (draw) => {
            const res = [];
            if(document.getElementById('boat-selector').value) {
                for(let i=1; i<=selectedRuns; i++) {
                    const r = analyzeRunData(i);
                    if(r) res.push(r);
                }
            }
            const ready = (res.length === selectedRuns && document.getElementById('crew-names').value.trim() !== '');
            document.getElementById('generate-chart-btn').disabled = !ready;
            
            if (draw && ready) {
                currentDataCache = res; 
                updateCharts(res);
                updateSummary(res);
                document.getElementById('speed-chart-container').classList.remove('hidden');
                document.getElementById('sr-chart-container').classList.remove('hidden');
                document.getElementById('summary-legend-container').classList.remove('hidden');
                document.getElementById('download-data-btn').disabled = false;
            }
            return res;
        };

        // --- AGGIORNAMENTO GRAFICI (CON CURVA IDEALE) ---
        function updateCharts(data) {
            const spdDatasets = [], srDatasets = [];
            let totalTime = 0, totalDist = 0;
            let minVal = 999, maxVal = 0;

            data.forEach((r, i) => {
                totalTime += r.totalSec; totalDist += r.distance;
                r.speedData.forEach(p => { 
                    if(p.y > 0) {
                        if(p.y < minVal) minVal = p.y; 
                        if(p.y > maxVal) maxVal = p.y;
                    }
                });

                spdDatasets.push({
                    label: `Int. ${r.runId}`,
                    data: r.speedData,
                    borderColor: r.color,
                    pointRadius: r.speedData.map(p => (p.y===r.maxSpd.y || p.y===r.minSpd.y) ? 6 : 3),
                    pointBackgroundColor: r.speedData.map(p => p.y===r.maxSpd.y ? '#38BDF8' : (p.y===r.minSpd.y ? '#F87171' : r.color)),
                    tension: 0.4 
                });
                srDatasets.push({
                    label: `Int. ${r.runId}`,
                    data: r.srData,
                    borderColor: r.color,
                    pointRadius: r.srData.map(p => (p.y===r.maxSr.y || p.y===r.minSr.y) ? 6 : 3),
                    pointBackgroundColor: r.srData.map(p => p.y===r.maxSr.y ? SR_POINT_MAX_COLOR : (p.y===r.minSr.y ? SR_POINT_MIN_COLOR : r.color)),
                    tension: 0.4
                });
            });

            // Calcolo Media Globale e Curva Ideale
            const globalAvg = totalDist / totalTime;
            
            // Zoom Aggressivo
            let suggestedMin = 0;
            if (minVal < 999 && maxVal > 0) {
                suggestedMin = Math.max(0, minVal - 0.2);
            }

            spdDatasets.push({
                label: 'Media Totale', data: [{x:0, y:globalAvg}, {x:selectedDistance, y:globalAvg}],
                borderColor: '#94a3b8', borderWidth: 2, borderDash: [10, 5], pointRadius: 0, fill: false, tension: 0
            });

            const boatType = document.getElementById('boat-selector').value;
            const idealCurve = getIdealCurvePoints(globalAvg, selectedDistance, boatType);
            spdDatasets.push({
                label: 'Curva Ideale', data: idealCurve,
                borderColor: '#F59E0B', borderWidth: 3, tension: 0.4, pointRadius: 0, fill: false
            });

            // Update Speed Chart
            chartInstanceSpeed.data.datasets = spdDatasets;
            chartInstanceSpeed.options.scales.x.max = selectedDistance;
            
            if (suggestedMin > 0) {
                chartInstanceSpeed.options.scales.y.min = suggestedMin;
            } else {
                delete chartInstanceSpeed.options.scales.y.min;
            }
            chartInstanceSpeed.update();

            // Update SR Chart
            chartInstanceSR.data.datasets = srDatasets;
            chartInstanceSR.options.scales.x.max = selectedDistance;
            chartInstanceSR.update();
        }

        // --- RIEPILOGO DETTAGLIATO ---
        function updateSummary(data) {
            const globalDiv = document.getElementById('global-summary');
            const listDiv = document.getElementById('run-summary-list');
            
            listDiv.innerHTML = '';
            globalDiv.innerHTML = '';

            let absoluteMaxSpd = { y: 0, runId: 0, dist: 0 };
            let fastestRun = null;
            let totalDistSum = 0;
            let totalTimeSum = 0;

            data.forEach(r => {
                if (r.maxSpd.y > absoluteMaxSpd.y) absoluteMaxSpd = { y: r.maxSpd.y, runId: r.runId, dist: r.maxSpd.x };
                if (!fastestRun || r.avgSpd > fastestRun.avgSpd) fastestRun = r;
                totalDistSum += selectedDistance;
                totalTimeSum += r.totalSec;
            });

            const overallAvgSpd = totalTimeSum > 0 ? (totalDistSum / totalTimeSum) : 0;
            
            const globalStats = [
                { label: "Miglior Intervallo", val: fastestRun ? `Int. ${fastestRun.runId}` : "-", sub: fastestRun ? `${toPace(fastestRun.avgSpd)} (${fastestRun.avgSpd.toFixed(2)} m/s)` : "", color: "text-emerald-400" },
                { label: "Picco Velocità Max", val: absoluteMaxSpd.y > 0 ? `${absoluteMaxSpd.y.toFixed(2)} m/s` : "-", sub: absoluteMaxSpd.y > 0 ? `${toPace(absoluteMaxSpd.y)} (Int. ${absoluteMaxSpd.runId} @ ${absoluteMaxSpd.dist}m)` : "", color: "text-blue-400" },
                { label: "Media Totale", val: overallAvgSpd > 0 ? toPace(overallAvgSpd) : "-", sub: overallAvgSpd > 0 ? `${overallAvgSpd.toFixed(2)} m/s` : "Totale Cumulativo", color: "text-indigo-400" }
            ];

            globalStats.forEach(stat => {
                globalDiv.innerHTML += `
                    <div class="bg-slate-700/50 border border-slate-600/50 p-4 rounded-xl shadow-lg">
                        <div class="stat-label mb-1">${stat.label}</div>
                        <div class="stat-value ${stat.color}">${stat.val}</div>
                        <div class="stat-sub">${stat.sub}</div>
                    </div>`;
            });

            data.forEach(r => {
                const avgPace = toPace(r.avgSpd);
                const minPace = toPace(r.minSpd.y); 
                const maxPace = toPace(r.maxSpd.y);

                listDiv.innerHTML += `
                    <div class="bg-slate-800/80 border-l-4 p-4 rounded-lg shadow-md" style="border-color:${r.color}">
                        <div class="card-header flex justify-between items-end">
                            <div>
                                <h3 class="font-bold text-lg text-white flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full" style="background:${r.color}"></span>
                                    Intervallo ${r.runId}
                                </h3>
                            </div>
                            <div class="text-right">
                                <span class="stat-label block mb-0.5">Tempo</span>
                                <span class="text-xl font-bold text-white tracking-wide">${r.totalTimeStr}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 border-b border-slate-700 pb-1">Velocità / Passo</h4>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div class="bg-slate-700/30 p-2 rounded">
                                        <div class="stat-label text-emerald-400">Max</div>
                                        <div class="font-bold text-white text-sm">${maxPace}</div>
                                        <div class="text-[10px] text-slate-400">${r.maxSpd.y.toFixed(2)}</div>
                                    </div>
                                    <div class="bg-slate-700/50 p-2 rounded border border-slate-600/30">
                                        <div class="stat-label text-blue-300">Media</div>
                                        <div class="font-bold text-white text-lg">${avgPace}</div>
                                        <div class="text-[10px] text-slate-400">${r.avgSpd.toFixed(2)} m/s</div>
                                    </div>
                                    <div class="bg-slate-700/30 p-2 rounded">
                                        <div class="stat-label text-red-400">Min</div>
                                        <div class="font-bold text-white text-sm">${minPace}</div>
                                        <div class="text-[10px] text-slate-400">${r.minSpd.y.toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 border-b border-slate-700 pb-1">Frequenza (SR)</h4>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div class="bg-slate-700/30 p-2 rounded">
                                        <div class="stat-label text-yellow-400">Max</div>
                                        <div class="font-bold text-white text-sm">${r.maxSr.y}</div>
                                    </div>
                                    <div class="bg-slate-700/50 p-2 rounded border border-slate-600/30">
                                        <div class="stat-label text-orange-300">Media</div>
                                        <div class="font-bold text-white text-lg">${r.avgSr.toFixed(1)}</div>
                                    </div>
                                    <div class="bg-slate-700/30 p-2 rounded">
                                        <div class="stat-label text-slate-400">Min</div>
                                        <div class="font-bold text-white text-sm">${r.minSr.y}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
        }

        window.generateChartAndSaveData = (save) => {
            const results = updateAllData(true);
            if(!results.length) return;

            if (save) {
                const docData = {
                    boat: document.getElementById('boat-selector').value,
                    crewString: document.getElementById('crew-names').value,
                    distance: selectedDistance,
                    runsCount: selectedRuns,
                    runs: results,
                    timestamp: serverTimestamp(),
                    uid: auth.currentUser ? auth.currentUser.uid : 'anon'
                };
                saveRunData(docData);
            } else {
                document.getElementById('download-data-btn').disabled = false;
            }
        };

        // --- PDF GENERATION (Motore Admin) ---
        async function generateChartImageForPDF(runs, type, globalAvg) {
            const ctx = document.getElementById('hiddenPdfCanvas').getContext('2d');
            if (hiddenChartInstance) hiddenChartInstance.destroy();
            
            let minVal = 999;
            if(type === 'speed') {
                runs.forEach(r => r.speedData.forEach(p => { if(p.y > 0 && p.y < minVal) minVal = p.y; }));
            }

            const datasets = runs.map((run, i) => {
                const color = COLORS[i % COLORS.length];
                const data = (type === 'speed') ? run.speedData : run.srData;
                return { 
                    label: `Run ${run.runId}`, data: data, 
                    borderColor: color, borderWidth: 3, pointRadius: 0, tension: 0.4, fill: false, 
                    parsing: { xAxisKey: 'x', yAxisKey: 'y' } 
                };
            });

            if(type === 'speed' && globalAvg) {
                 datasets.push({
                    label: 'Media Totale', data: [{x: 0, y: globalAvg}, {x: selectedDistance, y: globalAvg}],
                    borderColor: '#94a3b8', borderWidth: 2, borderDash: [10, 5], pointRadius: 0, fill: false, tension: 0
                });
                const boatType = document.getElementById('boat-selector').value;
                datasets.push({
                    label: 'Curva Ideale', data: getIdealCurvePoints(globalAvg, selectedDistance, boatType),
                    borderColor: '#F59E0B', borderWidth: 2, tension: 0.4, pointRadius: 0, fill: false
                });
            }
            
            let suggestedMin = undefined;
            if (type === 'speed' && minVal < 999) {
                suggestedMin = Math.max(0, minVal - 0.2);
            }

            hiddenChartInstance = new Chart(ctx, { 
                type: 'line', data: { datasets: datasets }, 
                options: { 
                    responsive: false, animation: false, 
                    scales: { 
                        x: { type: 'linear', display: true, grid: { color: '#e2e8f0' }, ticks: { font: { size: 16 } } }, 
                        y: { 
                            display: true, grid: { color: '#e2e8f0' }, ticks: { font: { size: 16 } },
                            min: suggestedMin 
                        } 
                    }, 
                    plugins: { legend: { display: true, labels: { font: { size: 16 } } } } 
                } 
            });
            return document.getElementById('hiddenPdfCanvas').toDataURL('image/jpeg', 0.9);
        }

        window.downloadPdf = async () => {
            const btn = document.getElementById('download-data-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Generazione..."; btn.disabled = true;

            try {
                let runs = currentDataCache;
                if (!runs) runs = updateAllData(false);
                if (!runs || !runs.length) throw new Error("Nessun dato valido");

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const chartData = {
                    boat: document.getElementById('boat-selector').value,
                    crewString: document.getElementById('crew-names').value,
                    timestamp: new Date(),
                    runs: runs,
                    distance: selectedDistance
                };

                await drawPdfPage(doc, chartData);
                doc.save(`Analisi_${chartData.boat}_${chartData.crewString}.pdf`);

            } catch(e) { 
                console.error(e); 
                alert("Errore PDF: " + e.message); 
            } finally { 
                btn.innerHTML = originalText; btn.disabled = false; 
            }
        };

        async function drawPdfPage(doc, chartData) {
            doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.setFont("helvetica", "bold");
            doc.text(`Analisi Tecnica: ${chartData.crewString}`, 14, 18);
            doc.setFontSize(12); doc.setTextColor(200, 200, 200); doc.setFont("helvetica", "normal");
            doc.text(`${chartData.boat} | ${chartData.timestamp.toLocaleDateString('it-IT')} | ${chartData.distance}m x ${chartData.runs.length}`, 14, 28);
            
            const headers = ['METRICA'];
            chartData.runs.forEach(r => headers.push(`RUN ${r.runId}`));
            const runStats = chartData.runs.map(run => calculateTechnicalStats(run.speedData, run.srData, run.distance, run.totalSeconds));
            const sd = (v) => isFinite(v) ? v.toFixed(2) : '-';

            // Calcolo Media Globale
            let totT=0, totD=0;
            chartData.runs.forEach(r=>{ totT+=r.totalSeconds; totD+=r.distance; });
            const globalAvg = totD/totT;

            const rows = [
                [{content: 'SPEEDY (m/s)', colSpan: headers.length, styles: {fillColor: [153, 27, 27], textColor: [255,255,255], fontStyle: 'bold', halign:'center'}}],
                ['MAX', ...runStats.map(s => s.maxSpeed.toFixed(2))],
                ['MIN', ...runStats.map(s => s.minSpeed.toFixed(2))],
                ['AVG', ...runStats.map(s => s.avgSpeed.toFixed(2))],
                
                [{content: 'DELTA SPEEDY', colSpan: headers.length, styles: {fillColor: [127, 29, 29], textColor: [255,200,200], fontStyle: 'bold', halign:'center'}}],
                ['MX/MN', ...runStats.map(s => sd(s.maxSpeed-s.minSpeed))],
                ['MX/AV', ...runStats.map(s => sd(s.maxSpeed-s.avgSpeed))],
                ['MN/AV', ...runStats.map(s => sd(s.avgSpeed-s.minSpeed))],

                [{content: 'WATT (Mech)', colSpan: headers.length, styles: {fillColor: [154, 52, 18], textColor: [255,255,255], fontStyle: 'bold', halign:'center'}}],
                ['MAX', ...runStats.map(s => s.maxWatt.toFixed(0))],
                ['MIN', ...runStats.map(s => s.minWatt.toFixed(0))],
                ['AVG', ...runStats.map(s => s.avgWatt.toFixed(0))],

                [{content: 'DELTA WATT', colSpan: headers.length, styles: {fillColor: [124, 45, 18], textColor: [255,200,200], fontStyle: 'bold', halign:'center'}}],
                ['MX/MN', ...runStats.map(s => sd(s.maxWatt-s.minWatt))],
                ['MX/AV', ...runStats.map(s => sd(s.maxWatt-s.avgWatt))],
                ['MN/AV', ...runStats.map(s => sd(s.avgWatt-s.minWatt))],

                [{content: 'STROKES', colSpan: headers.length, styles: {fillColor: [49, 46, 129], textColor: [255,255,255], fontStyle: 'bold', halign:'center'}}],
                ['MAX', ...runStats.map(s => s.maxSr.toFixed(0))],
                ['MIN', ...runStats.map(s => s.minSr.toFixed(0))],
                ['AVG', ...runStats.map(s => s.avgSr.toFixed(1))],

                [{content: 'DELTA STROKES', colSpan: headers.length, styles: {fillColor: [30, 27, 75], textColor: [200,200,255], fontStyle: 'bold', halign:'center'}}],
                ['MX/MN', ...runStats.map(s => sd(s.maxSr-s.minSr))],
                ['MX/AV', ...runStats.map(s => sd(s.maxSr-s.avgSr))],
                ['MN/AV', ...runStats.map(s => sd(s.avgSr-s.minSr))],
            ];

            let y = 50;
            doc.autoTable({
                startY: y, head: [headers], body: rows, theme: 'grid',
                headStyles: { fillColor: [255, 200, 0], textColor: [0,0,0], fontStyle: 'bold', halign: 'center' },
                bodyStyles: { halign: 'center', fontSize: 9 },
                columnStyles: { 0: { fontStyle: 'bold', halign: 'left', fillColor: [245, 245, 245] } },
                margin: { left: 14, right: 14 }
            });

            y = doc.lastAutoTable.finalY + 15;
            
            if (y + 100 > 280) { doc.addPage(); y = 20; }
            doc.setFontSize(12); doc.setTextColor(50); doc.setFont("helvetica", "bold");
            doc.text("Velocità (m/s)", 14, y);
            y += 5;
            const imgSpd = await generateChartImageForPDF(chartData.runs, 'speed', globalAvg);
            doc.addImage(imgSpd, 'JPEG', 14, y, 182, 70);
            
            y += 80;
            if (y + 80 > 280) { doc.addPage(); y = 20; }
            doc.text("Frequenza (SPM)", 14, y);
            y += 5;
            const imgSr = await generateChartImageForPDF(chartData.runs, 'sr', null);
            doc.addImage(imgSr, 'JPEG', 14, y, 182, 70);

            y += 80;
            if (y > 250) { doc.addPage(); y = 20; }
            const splitBody = [];
            chartData.runs.forEach(run => {
                const maxD = run.speedData.length > 0 ? run.speedData[run.speedData.length-1].x : 0;
                for(let d=100; d<=maxD; d+=100) {
                    const pt = run.speedData.find(p => p.x >= d);
                    const srPt = run.srData.find(p => p.x >= d);
                    if(pt) splitBody.push([`Run ${run.runId}`, `${d}m`, secondsToPaceString(PACE_REFERENCE_DISTANCE/pt.y), pt.y.toFixed(2), srPt ? srPt.y.toFixed(0) : '-']);
                }
            });
            doc.autoTable({ startY: y, head: [['Run', 'Dist', 'Passo', 'm/s', 'SR']], body: splitBody, theme: 'striped', headStyles: { fillColor: [59, 130, 246] }, styles: { fontSize: 8, cellPadding: 1, halign: 'center' }, margin: { left: 14, right: 14 } });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('messageBoxOkBtn').addEventListener('click', () => 
                document.getElementById('messageBox').classList.add('hidden'));

            document.getElementById('openHistoryBtn').addEventListener('click', openHistoryModal);
            document.getElementById('closeHistoryBtn').addEventListener('click', () => {
                document.getElementById('historyModal').classList.add('hidden');
            });

            const chartOpts = {
                type: 'line', 
                data: {datasets:[]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'Distanza (m)', color:'#94A3B8' }, grid: {color:'rgba(255,255,255,0.1)'}, ticks:{color:'#CBD5E1', stepSize: 100} },
                        y: { grid: {color:'rgba(255,255,255,0.1)'}, ticks:{color:'#CBD5E1'} }
                    },
                    plugins: { legend: {labels:{color:'#E2E8F0'}} }
                }
            };
            chartInstanceSpeed = new Chart(document.getElementById('performanceChartSpeed'), JSON.parse(JSON.stringify(chartOpts)));
            chartInstanceSR = new Chart(document.getElementById('performanceChartSR'), JSON.parse(JSON.stringify(chartOpts)));
            renderBoatSelector();
        });
    </script>
</body>
</html>
