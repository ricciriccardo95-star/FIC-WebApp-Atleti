<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Intervalli Squadra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <script type="module" src="../auth-manager.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #E2E8F0;
            -webkit-font-smoothing: antialiased;
        }
        .background-gradient {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            filter: blur(100px); z-index: -1;
        }
        .gradient-1 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.3), transparent 70%);
            animation: pulse 10s infinite alternate;
        }
        .gradient-2 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.2), transparent 70%);
            animation: pulse 12s infinite alternate-reverse;
        }
        @keyframes pulse {
            0% { transform: scale(0.9) rotate(0deg); }
            100% { transform: scale(1.2) rotate(20deg); }
        }
        .stat-label { font-size: 0.65rem; text-transform: uppercase; color: #94A3B8; letter-spacing: 0.05em; font-weight: 600; }
        .stat-value { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-weight: 700; color: #F8FAFC; font-size: 1.1rem; }
        .stat-sub { font-size: 0.75rem; color: #64748B; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .card-header { border-bottom: 1px solid rgba(148, 163, 184, 0.1); padding-bottom: 0.5rem; margin-bottom: 0.75rem; }
    </style>
</head>
<body class="antialiased min-h-screen">

    <div class="background-gradient gradient-1"></div>
    <div class="background-gradient gradient-2"></div>

    <div class="p-4 md:p-8 max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl md:text-4xl font-black tracking-tight text-slate-100">Grafici & Analisi</h1>
            <a href="home_carica_dati.html" class="p-2 bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors shadow-lg border border-slate-700">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
            </a>
        </div>

        <p class="text-md text-slate-400 text-center mb-8">Inserisci i dati degli intervalli per generare grafici e statistiche dettagliate.</p>

        <div class="bg-slate-800/70 border border-slate-700/50 rounded-xl p-4 mb-6 shadow-xl backdrop-blur-sm grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <label for="boat-selector" class="block text-sm font-medium text-slate-300 mb-1">Barca</label>
                <select id="boat-selector" onchange="handleSelectionChange()" class="w-full p-2 bg-slate-700/70 border border-slate-600 rounded-lg text-white font-semibold focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="" disabled selected>Seleziona</option>
                    </select>
            </div>
            
            <div>
                <label for="crew-names" class="block text-sm font-medium text-slate-300 mb-1">Equipaggio</label>
                <input type="text" id="crew-names" oninput="checkGenerationReadiness()" class="w-full p-2 bg-slate-700/70 border border-slate-600 rounded-lg text-white font-semibold focus:ring-2 focus:ring-blue-500 outline-none placeholder-slate-500" placeholder="Es. Rossi, Bianchi...">
            </div>

            <div id="distance-wrapper" class="hidden">
                <label for="distance-selector" class="block text-sm font-medium text-slate-300 mb-1">Distanza (m)</label>
                <select id="distance-selector" onchange="handleSelectionChange()" class="w-full p-2 bg-slate-700/70 border border-slate-600 rounded-lg text-white font-semibold focus:ring-2 focus:ring-blue-500 outline-none">
                    </select>
            </div>

            <div id="runs-wrapper" class="hidden">
                <label for="runs-selector" class="block text-sm font-medium text-slate-300 mb-1">N. Ripetute</label>
                <select id="runs-selector" onchange="handleSelectionChange()" class="w-full p-2 bg-slate-700/70 border border-slate-600 rounded-lg text-white font-semibold focus:ring-2 focus:ring-blue-500 outline-none">
                    </select>
            </div>
        </div>

        <div id="input-runs-container" class="space-y-6">
            <div class="p-6 text-center text-slate-400 bg-slate-800/50 border border-slate-700/50 rounded-xl">
                Seleziona Barca, Distanza e Numero Intervalli per iniziare.
            </div>
        </div>
        
        <div class="mt-8 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="generate-chart-btn" onclick="generateChartAndSaveData(true)" disabled class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-xl transition-colors disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                Genera & Salva
            </button>
            <button id="download-data-btn" onclick="downloadPdf()" disabled class="px-8 py-3 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded-lg shadow-xl transition-colors disabled:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Scarica PDF
            </button>
        </div>
        
        <div id="speed-chart-container" class="mt-8 bg-slate-800/70 border border-slate-700/50 rounded-xl p-4 md:p-6 shadow-xl backdrop-blur-sm hidden">
            <h2 class="text-xl font-bold text-slate-100 mb-4">Grafico 1: Velocità (m/s)</h2>
            <div class="h-64 md:h-96"><canvas id="performanceChartSpeed"></canvas></div>
        </div>

        <div id="sr-chart-container" class="mt-8 bg-slate-800/70 border border-slate-700/50 rounded-xl p-4 md:p-6 shadow-xl backdrop-blur-sm hidden">
            <h2 class="text-xl font-bold text-slate-100 mb-4">Grafico 2: Colpi (SR)</h2>
            <div class="h-64 md:h-96"><canvas id="performanceChartSR"></canvas></div>
        </div>

        <div id="summary-legend-container" class="mt-8 bg-slate-800/70 border border-slate-700/50 rounded-xl p-4 md:p-6 hidden">
            <h2 class="text-xl font-bold text-slate-100 mb-4">Riepilogo Prestazioni</h2>
            
            <div id="global-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"></div>

            <h3 class="text-lg font-bold text-slate-200 mb-3 border-t border-slate-700 pt-4">Dettaglio Intervalli</h3>
            <div id="run-summary-list" class="space-y-4"></div>
        </div>

        <div id="messageBox" class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center hidden backdrop-blur-sm">
            <div class="bg-slate-800 border border-slate-700 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
                <h3 id="messageBoxTitle" class="text-lg font-bold text-slate-100 mb-3">Messaggio</h3>
                <p id="messageBoxContent" class="text-slate-300 mb-6"></p>
                <button id="messageBoxOkBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition-colors">OK</button>
            </div>
        </div>
        
    </div>

    <script type="module">
        // Importazioni da Auth Manager e Firestore
        import { db, auth } from '../auth-manager.js';
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- CONFIGURAZIONE ---
        const AVAILABLE_DISTANCES = [500, 750, 1000, 1500, 2000];
        const MAX_RUNS = 10;
        const SEGMENT_DISTANCE = 100;
        const PACE_REFERENCE_DISTANCE = 500;
        const COLORS = ['#4ADE80', '#0EA5E9', '#F472B6', '#FACC15', '#A78BFA', '#FB923C', '#E11D48', '#14B8A6', '#64748B', '#A3E635'];
        const SR_POINT_MAX_COLOR = '#FACC15'; 
        const SR_POINT_MIN_COLOR = '#E11D48';

        const BOATS = ['M1X', 'M2X', 'M4X', 'M2-', 'M4-', 'M8+', 'W1X', 'W2X', 'W4X', 'W2-', 'W4-', 'W8+'];

        let chartInstanceSpeed, chartInstanceSR;
        let selectedDistance = 2000; 
        let selectedRuns = 1;

        // --- UTILITY ---
        const showMessageBox = (title, message) => {
            document.getElementById('messageBoxTitle').textContent = title;
            document.getElementById('messageBoxContent').textContent = message;
            document.getElementById('messageBox').classList.remove('hidden');
        };

        const toPace = (mps) => {
            if (!mps || mps <= 0) return "-";
            const totalSeconds = 500 / mps;
            const m = Math.floor(totalSeconds / 60);
            const s = (totalSeconds % 60).toFixed(1).padStart(4, '0');
            return `${m}:${s}`;
        };

        // --- SALVATAGGIO DATI ---
        async function saveRunData(dataToSave) {
            const saveButton = document.getElementById('generate-chart-btn');
            saveButton.disabled = true;
            saveButton.textContent = "Salvataggio...";

            try {
                await addDoc(collection(db, "graphics"), dataToSave);
                showMessageBox("Successo!", `Allenamento salvato correttamente.`);
                saveButton.textContent = "Genera & Salva";
                document.getElementById('download-data-btn').disabled = false;
            } catch (error) {
                console.error("Errore save:", error);
                showMessageBox("Errore", `Impossibile salvare: ${error.message}`);
                saveButton.disabled = false;
                saveButton.textContent = "Genera & Salva";
            }
        }
        
        // --- LOGICA INTERFACCIA ---
        function renderBoatSelector() {
            const sel = document.getElementById('boat-selector');
            sel.innerHTML = '<option value="" disabled selected>Seleziona Barca</option>';
            BOATS.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b; opt.textContent = b; sel.appendChild(opt);
            });
            renderDistanceSelector();
            renderRunsSelector();
        }

        function renderDistanceSelector() {
            const sel = document.getElementById('distance-selector');
            sel.innerHTML = '';
            AVAILABLE_DISTANCES.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d; opt.textContent = `${d} metri`;
                if(d === selectedDistance) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function renderRunsSelector() {
            const sel = document.getElementById('runs-selector');
            sel.innerHTML = '';
            for (let i = 1; i <= MAX_RUNS; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = i;
                if(i === selectedRuns) opt.selected = true;
                sel.appendChild(opt);
            }
        }
        
        window.handleSelectionChange = () => {
            selectedDistance = parseInt(document.getElementById('distance-selector').value);
            selectedRuns = parseInt(document.getElementById('runs-selector').value);
            
            if(document.getElementById('boat-selector').value) {
                document.getElementById('distance-wrapper').classList.remove('hidden');
                document.getElementById('runs-wrapper').classList.remove('hidden');
                renderInputs();
            }

            document.getElementById('speed-chart-container').classList.add('hidden');
            document.getElementById('sr-chart-container').classList.add('hidden');
            document.getElementById('summary-legend-container').classList.add('hidden');
            document.getElementById('download-data-btn').disabled = true;

            checkGenerationReadiness();
        };

        window.checkGenerationReadiness = () => {
            const boatSelected = document.getElementById('boat-selector').value !== '';
            const crewFilled = document.getElementById('crew-names').value.trim() !== '';
            const inputsRendered = document.getElementById('input-runs-container').querySelectorAll('.pace-input').length > 0;
            const allRunResults = updateAllData(false);
            const allRunsValid = (allRunResults.length === selectedRuns) && allRunResults.length > 0;
            document.getElementById('generate-chart-btn').disabled = !(allRunsValid && crewFilled && inputsRendered && boatSelected);
        };

        // --- FORMATTAZIONE INPUT ---
        window.formatPaceInput = (event) => {
            const input = event.target;
            let d = input.value.replace(/[^0-9]/g, ''); 
            if (d.length > 6) d = d.substring(0, 6);
            let val = '';
            if (d.length >= 1) {
                const dec = d.slice(-1); 
                let ss = d.slice(-3, -1);
                let m = d.slice(0, -3);
                if (ss.length === 2 && parseInt(ss) > 59) ss = '59';
                if (m) val = `${parseInt(m)}:${ss.padStart(2,'0')}.${dec}`;
                else if (ss.length === 2) val = `0:${ss}.${dec}`;
                else if (ss.length === 1) val = `0:0${ss}.${dec}`;
                else val = `0:00.${dec}`;
            }
            input.value = val;
            updateAllData(false);
        };

        window.formatSrInput = (event) => {
            const input = event.target;
            let d = input.value.replace(/[^0-9]/g, '');
            if (d.length > 3) d = d.substring(0, 3);
            let val = '';
            if (d.length === 3) val = `${d.substring(0,2)}.${d.substring(2)}`;
            else val = d;
            if ((event.data === '.' || event.data === ',') && !val.includes('.')) {
                if(val.length >=1) val += '.';
            }
            input.value = val;
            updateAllData(false);
        };

        // --- ANALISI ---
        function paceToSeconds(p) {
            if (!p) return 0;
            p = p.trim().replace(',', '.');
            const parts = p.split(':');
            if (parts.length === 2) {
                return (parseInt(parts[0])*60) + parseFloat(parts[1]);
            }
            return parseFloat(p) || 0;
        }

        function renderInputs() {
            const container = document.getElementById('input-runs-container');
            container.innerHTML = ''; 
            if (!document.getElementById('boat-selector').value) return;
            const numSegments = selectedDistance / SEGMENT_DISTANCE;

            for (let i = 1; i <= selectedRuns; i++) {
                const runId = i, runColor = COLORS[i - 1];
                let tableRows = '';
                for (let j = 1; j <= numSegments; j++) {
                    const dist = j * SEGMENT_DISTANCE;
                    tableRows += `
                        <tr class="hover:bg-slate-800/50 transition-colors border-b border-slate-700/50 last:border-0">
                            <td class="py-2 px-3 text-sm font-medium text-slate-400">${dist}</td>
                            <td class="py-2 px-3 text-center">
                                <input type="text" class="pace-input w-full md:w-24 p-1 text-center bg-slate-700/70 border border-slate-600 rounded text-sm text-white font-mono focus:border-blue-500 outline-none" placeholder="mm:ss.d" data-run-id="${runId}" data-distance="${dist}" oninput="formatPaceInput(event)" ${j === 1 ? `onpaste="handlePaste(event, ${runId})"` : ''} inputmode="decimal">
                            </td>
                            <td class="py-2 px-3 text-center">
                                <input type="text" class="sr-input w-full md:w-20 p-1 text-center bg-slate-700/70 border border-slate-600 rounded text-sm text-white font-mono focus:border-orange-500 outline-none" placeholder="nn.n" data-run-id="${runId}" data-distance="${dist}" oninput="formatSrInput(event)" inputmode="decimal">
                            </td>
                            <td id="speed-${runId}-${dist}" class="py-2 px-3 text-center text-sm text-emerald-400 font-mono">-</td>
                        </tr>`;
                }

                container.insertAdjacentHTML('beforeend', `
                    <div class="bg-slate-800/70 border border-slate-700/50 rounded-xl shadow-lg backdrop-blur-sm p-4 animate-fade-in">
                        <div class="flex items-center gap-3 mb-3">
                            <span style="background-color: ${runColor}; width: 12px; height: 12px; border-radius: 50%;"></span>
                            <h3 class="text-lg font-bold text-slate-100">Intervallo ${runId}</h3>
                        </div>
                        <div class="overflow-x-auto rounded-lg border border-slate-700/50">
                            <table class="min-w-full text-left">
                                <thead class="bg-slate-700/50 text-xs uppercase text-slate-400 font-semibold">
                                    <tr>
                                        <th class="py-2 px-3">Dist.</th>
                                        <th class="py-2 px-3 text-center">Passo</th>
                                        <th class="py-2 px-3 text-center">SR</th>
                                        <th class="py-2 px-3 text-center">m/s</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-700/50">${tableRows}</tbody>
                            </table>
                        </div>
                    </div>
                `);
            }
            checkGenerationReadiness();
        }

        window.handlePaste = (event, runId) => {
            event.preventDefault();
            const lines = event.clipboardData.getData('text').split(/[\n\r]+/).filter(s => s.trim().length > 0);
            const pInps = document.querySelectorAll(`.pace-input[data-run-id="${runId}"]`);
            const sInps = document.querySelectorAll(`.sr-input[data-run-id="${runId}"]`);
            
            lines.forEach((line, idx) => {
                const parts = line.split(/[\t\s]+/);
                if (pInps[idx] && parts[0]) {
                    pInps[idx].value = parts[0].replace(/[^0-9.]/g, '');
                    formatPaceInput({target: pInps[idx]});
                }
                if (sInps[idx] && parts[1]) {
                    sInps[idx].value = parts[1].replace(/[^0-9.]/g, '');
                    formatSrInput({target: sInps[idx]});
                }
            });
            updateAllData(false);
        };

        function analyzeRunData(runId) {
            const speedDP = [], srDP = [];
            let totalSec = 0, valid = true;
            let totalSr = 0, srCount = 0;
            
            const pInps = document.querySelectorAll(`.pace-input[data-run-id="${runId}"]`);
            const sInps = document.querySelectorAll(`.sr-input[data-run-id="${runId}"]`);
            
            pInps.forEach((inp, idx) => {
                const dist = parseInt(inp.dataset.distance);
                const secs = paceToSeconds(inp.value);
                const sr = parseFloat(sInps[idx].value);
                const disp = document.getElementById(`speed-${runId}-${dist}`);

                if (secs > 0) {
                    const spd = PACE_REFERENCE_DISTANCE / secs;
                    disp.textContent = spd.toFixed(2);
                    speedDP.push({x: dist, y: parseFloat(spd.toFixed(3)), pace: secs});
                    totalSec += (secs * (SEGMENT_DISTANCE / PACE_REFERENCE_DISTANCE));
                } else {
                    disp.textContent = '-';
                    valid = false;
                }

                if (sr > 0) {
                    srDP.push({x: dist, y: sr});
                    totalSr += sr; srCount++;
                } else {
                    valid = false;
                }
            });

            if (!valid || speedDP.length === 0) return null;

            const avgSpd = selectedDistance / totalSec;
            const maxSpd = speedDP.reduce((m,p)=> p.y > m.y ? p : m, {y:-1});
            const minSpd = speedDP.reduce((m,p)=> p.y < m.y ? p : m, {y:999});
            
            const avgSr = totalSr / srCount;
            const maxSr = srDP.reduce((m,p)=> p.y > m.y ? p : m, {y:-1});
            const minSr = srDP.reduce((m,p)=> p.y < m.y ? p : m, {y:999});

            return {
                runId, color: COLORS[runId-1],
                totalSec,
                totalTimeStr: `${Math.floor(totalSec/60)}:${(totalSec%60).toFixed(1).padStart(4,'0')}`,
                speedData: speedDP, srData: srDP,
                avgSpd, maxSpd, minSpd,
                avgSr, maxSr, minSr
            };
        }

        window.updateAllData = (draw) => {
            const res = [];
            if(document.getElementById('boat-selector').value) {
                for(let i=1; i<=selectedRuns; i++) {
                    const r = analyzeRunData(i);
                    if(r) res.push(r);
                }
            }
            const ready = (res.length === selectedRuns && document.getElementById('crew-names').value.trim() !== '');
            document.getElementById('generate-chart-btn').disabled = !ready;
            if (draw && ready) {
                updateCharts(res);
                updateSummary(res);
                document.getElementById('speed-chart-container').classList.remove('hidden');
                document.getElementById('sr-chart-container').classList.remove('hidden');
                document.getElementById('summary-legend-container').classList.remove('hidden');
            }
            return res;
        };

        function updateCharts(data) {
            // Speed Chart
            const spdDatasets = [];
            let minS = 99, maxS = 0;
            data.forEach(r => {
                r.speedData.forEach(p => { if(p.y<minS) minS=p.y; if(p.y>maxS) maxS=p.y; });
                spdDatasets.push({
                    label: `Int. ${r.runId}`,
                    data: r.speedData,
                    borderColor: r.color,
                    pointRadius: r.speedData.map(p => (p.y===r.maxSpd.y || p.y===r.minSpd.y) ? 6 : 3),
                    pointBackgroundColor: r.speedData.map(p => p.y===r.maxSpd.y ? '#38BDF8' : (p.y===r.minSpd.y ? '#F87171' : r.color)),
                    tension: 0.4 
                });
                spdDatasets.push({
                    label: `Media ${r.runId}`, data: [{x:0, y:r.avgSpd}, {x:selectedDistance, y:r.avgSpd}],
                    borderColor: r.color, borderDash: [5,5], pointRadius: 0
                });
            });
            chartInstanceSpeed.data.datasets = spdDatasets;
            chartInstanceSpeed.options.scales.y.min = minS - 0.2;
            chartInstanceSpeed.options.scales.y.max = maxS + 0.2;
            chartInstanceSpeed.options.scales.x.type = 'linear'; 
            chartInstanceSpeed.options.scales.x.min = 0;
            chartInstanceSpeed.options.scales.x.max = selectedDistance;
            chartInstanceSpeed.update();

            // SR Chart
            const srDatasets = [];
            let minSr = 99, maxSr = 0;
            data.forEach(r => {
                r.srData.forEach(p => { if(p.y<minSr) minSr=p.y; if(p.y>maxSr) maxSr=p.y; });
                srDatasets.push({
                    label: `Int. ${r.runId}`,
                    data: r.srData,
                    borderColor: r.color,
                    pointRadius: r.srData.map(p => (p.y===r.maxSr.y || p.y===r.minSr.y) ? 6 : 3),
                    pointBackgroundColor: r.srData.map(p => p.y===r.maxSr.y ? SR_POINT_MAX_COLOR : (p.y===r.minSr.y ? SR_POINT_MIN_COLOR : r.color)),
                    tension: 0.4
                });
            });
            chartInstanceSR.data.datasets = srDatasets;
            chartInstanceSR.options.scales.y.min = minSr - 2;
            chartInstanceSR.options.scales.y.max = maxSr + 2;
            chartInstanceSR.options.scales.x.type = 'linear';
            chartInstanceSR.options.scales.x.min = 0;
            chartInstanceSR.options.scales.x.max = selectedDistance;
            chartInstanceSR.update();
        }

        // --- RIEPILOGO DETTAGLIATO AGGIORNATO ---
        function updateSummary(data) {
            const globalDiv = document.getElementById('global-summary');
            const listDiv = document.getElementById('run-summary-list');
            
            listDiv.innerHTML = '';
            globalDiv.innerHTML = '';

            // CALCOLI GLOBALI
            let absoluteMaxSpd = { y: 0, runId: 0, dist: 0 };
            let fastestRun = null;
            let totalDistSum = 0;
            let totalTimeSum = 0;

            data.forEach(r => {
                // Trova picco assoluto
                if (r.maxSpd.y > absoluteMaxSpd.y) {
                    absoluteMaxSpd = { y: r.maxSpd.y, runId: r.runId, dist: r.maxSpd.x };
                }
                // Trova intervallo più veloce (media)
                if (!fastestRun || r.avgSpd > fastestRun.avgSpd) {
                    fastestRun = r;
                }
                totalDistSum += selectedDistance;
                totalTimeSum += r.totalSec;
            });

            const overallAvgSpd = totalTimeSum > 0 ? (totalDistSum / totalTimeSum) : 0;
            
            // RENDER GLOBALE
            const globalStats = [
                {
                    label: "Miglior Intervallo",
                    val: fastestRun ? `Int. ${fastestRun.runId}` : "-",
                    sub: fastestRun ? `${toPace(fastestRun.avgSpd)} (${fastestRun.avgSpd.toFixed(2)} m/s)` : "",
                    color: "text-emerald-400"
                },
                {
                    label: "Picco Velocità Max",
                    val: absoluteMaxSpd.y > 0 ? `${absoluteMaxSpd.y.toFixed(2)} m/s` : "-",
                    sub: absoluteMaxSpd.y > 0 ? `${toPace(absoluteMaxSpd.y)} (Int. ${absoluteMaxSpd.runId} @ ${absoluteMaxSpd.dist}m)` : "",
                    color: "text-blue-400"
                },
                {
                    label: "Media Totale Allenamento",
                    val: overallAvgSpd > 0 ? toPace(overallAvgSpd) : "-",
                    sub: overallAvgSpd > 0 ? `${overallAvgSpd.toFixed(2)} m/s` : "Totale Cumulativo",
                    color: "text-indigo-400"
                }
            ];

            globalStats.forEach(stat => {
                globalDiv.innerHTML += `
                    <div class="bg-slate-700/50 border border-slate-600/50 p-4 rounded-xl shadow-lg">
                        <div class="stat-label mb-1">${stat.label}</div>
                        <div class="stat-value ${stat.color}">${stat.val}</div>
                        <div class="stat-sub">${stat.sub}</div>
                    </div>
                `;
            });

            // RENDER LISTA INTERVALLI
            data.forEach(r => {
                const avgPace = toPace(r.avgSpd);
                const minPace = toPace(r.minSpd.y); // Peggiore
                const maxPace = toPace(r.maxSpd.y); // Migliore

                listDiv.innerHTML += `
                    <div class="bg-slate-800/80 border-l-4 p-4 rounded-lg shadow-md" style="border-color:${r.color}">
                        
                        <div class="card-header flex justify-between items-end">
                            <div>
                                <h3 class="font-bold text-lg text-white flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full" style="background:${r.color}"></span>
                                    Intervallo ${r.runId}
                                </h3>
                            </div>
                            <div class="text-right">
                                <span class="stat-label block mb-0.5">Tempo</span>
                                <span class="text-xl font-bold text-white tracking-wide">${r.totalTimeStr}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 border-b border-slate-700 pb-1">Velocità / Passo</h4>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div class="bg-slate-700/30 p-2 rounded">
                                        <div class="stat-label text-emerald-400">Max</div>
                                        <div class="font-bold text-white text-sm">${maxPace}</div>
                                        <div class="text-[10px] text-slate-400">${r.maxSpd.y.toFixed(2)}</div>
                                    </div>
                                    <div class="bg-slate-700/50 p-2 rounded border border-slate-600/30">
                                        <div class="stat-label text-blue-300">Media</div>
                                        <div class="font-bold text-white text-lg">${avgPace}</div>
                                        <div class="text-[10px] text-slate-400">${r.avgSpd.toFixed(2)} m/s</div>
                                    </div>
                                    <div class="bg-slate-700/30 p-2 rounded">
                                        <div class="stat-label text-red-400">Min</div>
                                        <div class="font-bold text-white text-sm">${minPace}</div>
                                        <div class="text-[10px] text-slate-400">${r.minSpd.y.toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 border-b border-slate-700 pb-1">Frequenza (SR)</h4>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div class="bg-slate-700/30 p-2 rounded">
                                        <div class="stat-label text-yellow-400">Max</div>
                                        <div class="font-bold text-white text-sm">${r.maxSr.y}</div>
                                    </div>
                                    <div class="bg-slate-700/50 p-2 rounded border border-slate-600/30">
                                        <div class="stat-label text-orange-300">Media</div>
                                        <div class="font-bold text-white text-lg">${r.avgSr.toFixed(1)}</div>
                                    </div>
                                    <div class="bg-slate-700/30 p-2 rounded">
                                        <div class="stat-label text-slate-400">Min</div>
                                        <div class="font-bold text-white text-sm">${r.minSr.y}</div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>`;
            });
        }

        window.generateChartAndSaveData = (save) => {
            const results = updateAllData(true);
            if(!results.length) return;

            if (save) {
                const docData = {
                    boat: document.getElementById('boat-selector').value,
                    crewString: document.getElementById('crew-names').value,
                    distance: selectedDistance,
                    runsCount: selectedRuns,
                    runs: results,
                    timestamp: serverTimestamp(),
                    uid: auth.currentUser ? auth.currentUser.uid : 'anon'
                };
                saveRunData(docData);
            } else {
                document.getElementById('download-data-btn').disabled = false;
            }
        };

        window.downloadPdf = () => {
            const results = updateAllData(false);
            if (!results.length) return;
            const boat = document.getElementById('boat-selector').value;
            const crew = document.getElementById('crew-names').value;
            const filename = `Analisi_${boat}_${crew.replace(/[^a-zA-Z0-9]/g,'_')}.pdf`;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

            const captureChart = (chart) => {
                const oldColor = Chart.defaults.color;
                const oldBorder = Chart.defaults.borderColor;
                Chart.defaults.color = '#000000';
                Chart.defaults.borderColor = '#cccccc';
                chart.options.scales.x.ticks.color = '#000';
                chart.options.scales.y.ticks.color = '#000';
                chart.options.plugins.legend.labels.color = '#000';
                chart.update();
                const img = chart.canvas.toDataURL('image/png', 1.0);
                Chart.defaults.color = '#E2E8F0';
                Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';
                chart.options.scales.x.ticks.color = '#CBD5E1';
                chart.options.scales.y.ticks.color = '#CBD5E1';
                chart.options.plugins.legend.labels.color = '#E2E8F0';
                chart.update();
                return img;
            };

            doc.setFontSize(18);
            doc.text(`Report: ${boat} - ${crew}`, 14, 15);
            doc.setFontSize(12);
            doc.text(`${selectedRuns}x${selectedDistance}m`, 14, 22);

            doc.addImage(captureChart(chartInstanceSpeed), 'PNG', 14, 30, 130, 80);
            doc.addImage(captureChart(chartInstanceSR), 'PNG', 150, 30, 130, 80);

            let y = 120;
            results.forEach(r => {
                if (y > 170) { doc.addPage(); y = 20; }
                const avgPace = toPace(r.avgSpd);
                doc.setFontSize(11);
                doc.setTextColor(0,0,0);
                doc.text(`Intervallo ${r.runId} (${r.totalTimeStr}) | Media: ${avgPace} (${r.avgSpd.toFixed(2)} m/s) | SR: ${r.avgSr.toFixed(1)}`, 14, y);
                y += 5;
                const body = r.speedData.map((p, i) => [
                    p.x, 
                    (PACE_REFERENCE_DISTANCE/p.y).toFixed(2),
                    r.srData[i].y.toFixed(1), 
                    p.y.toFixed(2)
                ]);
                doc.autoTable({
                    startY: y,
                    head: [['Dist', 'Sec (approx)', 'SR', 'm/s']],
                    body: body,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    margin: { left: 14 }
                });
                y = doc.lastAutoTable.finalY + 10;
            });
            doc.save(filename);
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('messageBoxOkBtn').addEventListener('click', () => 
                document.getElementById('messageBox').classList.add('hidden'));

            const chartOpts = {
                type: 'line', 
                data: {datasets:[]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'Distanza (m)', color:'#94A3B8' }, grid: {color:'rgba(255,255,255,0.1)'}, ticks:{color:'#CBD5E1', stepSize: 100} },
                        y: { grid: {color:'rgba(255,255,255,0.1)'}, ticks:{color:'#CBD5E1'} }
                    },
                    plugins: { legend: {labels:{color:'#E2E8F0'}} }
                }
            };
            chartInstanceSpeed = new Chart(document.getElementById('performanceChartSpeed'), JSON.parse(JSON.stringify(chartOpts)));
            chartInstanceSR = new Chart(document.getElementById('performanceChartSR'), JSON.parse(JSON.stringify(chartOpts)));
            renderBoatSelector();
        });
    </script>
</body>
</html>
