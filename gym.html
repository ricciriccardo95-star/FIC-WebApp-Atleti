<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym - I Tuoi Allenamenti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #E2E8F0;
        }
        .background-gradient {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            filter: blur(100px); z-index: -1;
        }
        .gradient-1 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.3), transparent 70%);
            animation: pulse 10s infinite alternate;
        }
        .gradient-2 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.2), transparent 70%);
            animation: pulse 12s infinite alternate-reverse;
        }
        @keyframes pulse {
            0% { transform: scale(0.9) rotate(0deg); }
            100% { transform: scale(1.2) rotate(20deg); }
        }
        /* Stili per l'accordion */
        .plan-card summary {
            cursor: pointer;
            outline: none;
        }
        .plan-card[open] summary {
            border-bottom: 1px solid #334155;
        }
        .plan-card summary::-webkit-details-marker {
            display: none;
        }
        .plan-card summary .icon {
            transition: transform 0.2s;
        }
        .plan-card[open] summary .icon {
            transform: rotate(90deg);
        }
        /* Stile per il lightbox dell'immagine */
        #image-lightbox {
            transition: opacity 0.3s ease;
        }
    </style>
     <!-- Carica l'auth-manager -->
     <script type="module" src="auth-manager.js"></script>
</head>
<body class="antialiased">

    <div class="background-gradient gradient-1"></div>
    <div class="background-gradient gradient-2"></div>

    <div id="loader-overlay" class="fixed inset-0 bg-slate-900/80 flex flex-col justify-center items-center z-50">
        <div class="h-16 w-16 animate-spin rounded-full border-4 border-t-4 border-slate-600 border-t-sky-500"></div>
        <p class="mt-4 text-slate-300">Caricamento dati...</p>
    </div>

    <div class="p-4 md:p-8 max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-10 border-b border-slate-700 pb-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-black text-slate-100">La Tua Gym</h1>
                <p id="welcome-message" class="text-lg text-sky-400 font-semibold"></p>
            </div>
            <a href="../home.html" class="inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold rounded-lg shadow transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                Home
            </a>
        </header>

        <main id="main-content" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-6">Le Tue Schede di Allenamento</h2>
            <div id="plans-container" class="space-y-6">
                <!-- Le schede verranno inserite qui da JS -->
            </div>
             <div id="no-plans-message" class="hidden text-center py-16 px-6 bg-slate-900/70 border border-slate-700/50 rounded-xl">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-slate-500"><rect x="3" y="10" width="4" height="4" rx="1"/><rect x="17" y="10" width="4" height="4" rx="1"/><line x1="7" y1="12" x2="17" y2="12"/></svg>
                <h3 class="text-xl font-bold text-white">Nessuna scheda trovata</h3>
                <p class="text-slate-400 mt-2">Non ci sono ancora schede di allenamento disponibili. Contatta il tuo allenatore.</p>
            </div>
        </main>
    </div>

    <!-- Image Lightbox Modal -->
    <div id="image-lightbox" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4 opacity-0">
        <div class="relative max-w-3xl max-h-full">
            <img id="lightbox-image" src="" alt="Esercizio ingrandito" class="block max-h-[90vh] max-w-[90vw] rounded-lg shadow-2xl">
            <button id="close-lightbox" class="absolute -top-2 -right-2 bg-white text-slate-900 rounded-full h-8 w-8 flex items-center justify-center font-bold text-xl leading-none">&times;</button>
        </div>
    </div>

    <script type="module">
        // Importa db da auth-manager
        import { db } from './auth-manager.js';
        // Importa solo le funzioni necessarie da firestore
        import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Rimuovi inizializzazione locale Firebase (app, auth, db, firebaseConfig)
        
        const loader = document.getElementById('loader-overlay');
        const mainContent = document.getElementById('main-content');
        const welcomeMessage = document.getElementById('welcome-message');
        const plansContainer = document.getElementById('plans-container');
        const noPlansMessage = document.getElementById('no-plans-message');
        const imageLightbox = document.getElementById('image-lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const closeLightboxBtn = document.getElementById('close-lightbox');

        // Rimuovi onAuthStateChanged
        
        // Ascolta l'evento 'authStateReady'
        document.addEventListener('authStateReady', async (e) => {
            const { athlete, error } = e.detail;

            if (athlete) {
                // Utente loggato e dati atleta disponibili
                if (athlete.cognome) {
                    welcomeMessage.textContent = `Benvenuto, ${athlete.cognome}`;
                    // Salva il cognome in sessionStorage se necessario altrove
                    sessionStorage.setItem('atletaCognome', athlete.cognome);
                } else {
                    welcomeMessage.textContent = 'Benvenuto';
                    sessionStorage.removeItem('atletaCognome'); // Rimuovi se non presente
                }
                await loadClientData(athlete); // Passa l'oggetto athlete
            } else if (error) {
                 // Errore
                console.error("Errore di autenticazione da auth-manager:", error);
                welcomeMessage.textContent = "Errore";
                plansContainer.innerHTML = `<p class="text-red-400 text-center">Impossibile verificare l'utente. Riprova il login.</p>`;
                loader.classList.add('hidden');
                mainContent.classList.remove('hidden'); // Mostra il messaggio di errore
            } else {
                // Utente non loggato (auth-manager dovrebbe aver reindirizzato)
                window.location.href = 'index.html';
            }
        });


        // Modifica loadClientData per accettare l'oggetto athlete
        async function loadClientData(athlete) {
            try {
                // 1. Usa l'ID dell'atleta direttamente dall'oggetto athlete
                const athleteId = athlete.id;

                // 2. Carica i massimali dell'atleta (usa 'db' importato)
                const massimaliMap = new Map();
                const massimaliQuery = query(collection(db, 'massimali_atleti'), where('atletaId', '==', athleteId));
                const massimaliSnapshot = await getDocs(massimaliQuery);
                massimaliSnapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.esercizioId && data.massimale) {
                        massimaliMap.set(data.esercizioId, data.massimale);
                    }
                });

                // 3. Carica la libreria di tutti gli esercizi (usa 'db' importato)
                const eserciziMap = new Map();
                const eserciziQuery = query(collection(db, "esercizi_pesistica"));
                const eserciziSnapshot = await getDocs(eserciziQuery);
                eserciziSnapshot.forEach(doc => {
                    eserciziMap.set(doc.id, doc.data());
                });

                // 4. Carica tutte le schede di allenamento (usa 'db' importato)
                const schedeQuery = query(collection(db, "schede_pesistica"));
                const schedeSnapshot = await getDocs(schedeQuery);

                if(schedeSnapshot.empty) {
                    noPlansMessage.classList.remove('hidden');
                } else {
                    plansContainer.innerHTML = ''; // Pulisce prima di aggiungere nuove schede
                    const schede = schedeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    schede.sort((a, b) => a.nomeScheda.localeCompare(b.nomeScheda));
                    
                    schede.forEach(scheda => {
                        const planElement = createPlanElement(scheda, massimaliMap, eserciziMap);
                        plansContainer.appendChild(planElement);
                    });
                    noPlansMessage.classList.add('hidden'); // Nasconde il messaggio se ci sono schede
                }

            } catch (error) {
                console.error("Errore nel caricamento dei dati: ", error);
                plansContainer.innerHTML = `<p class="text-red-400 text-center">Impossibile caricare i dati. Riprova più tardi.</p>`;
                noPlansMessage.classList.add('hidden'); // Nasconde msg "nessuna scheda" se c'è errore
            } finally {
                loader.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }
        }

        function createPlanElement(scheda, massimaliMap, eserciziMap) {
            const details = document.createElement('details');
            details.className = 'plan-card bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg overflow-hidden';

            const summary = document.createElement('summary');
            summary.className = 'flex justify-between items-center p-4 md:p-6';
            summary.innerHTML = `
                <h3 class="text-xl font-bold text-white">${scheda.nomeScheda}</h3>
                <div class="icon text-sky-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            `;

            const content = document.createElement('div');
            content.className = 'p-4 md:p-6 border-t border-slate-700/50';
            const exerciseList = document.createElement('div');
            exerciseList.className = 'space-y-4';

            if (scheda.esercizi && scheda.esercizi.length > 0) {
                scheda.esercizi.forEach(esercizio => {
                    // Controllo di base per assicurarsi che esercizio.esercizioId esista
                    if (!esercizio.esercizioId) {
                        console.warn("Esercizio senza ID trovato nella scheda:", scheda.nomeScheda, esercizio);
                        return; // Salta questo esercizio
                    }

                    const fullEsercizio = eserciziMap.get(esercizio.esercizioId);
                    const imageUrl = fullEsercizio?.imageUrl || 'https://placehold.co/100x100/334155/e2e8f0?text=IMG';
                    
                    const massimale = massimaliMap.get(esercizio.esercizioId) || 0;
                    const percentuale = parseFloat(esercizio.percentuale) || 0;
                    // Calcola peso solo se massimale e percentuale sono validi
                    const pesoCalcolato = massimale > 0 && percentuale > 0 ? (massimale * percentuale / 100).toFixed(1) : '-';
                    // Fallback per nome esercizio
                    const nomeEsercizio = esercizio.nome || fullEsercizio?.nome || 'Esercizio Sconosciuto';


                    exerciseList.innerHTML += `
                        <div class="flex flex-col sm:flex-row items-center gap-4 p-4 bg-slate-800 rounded-lg">
                            <img src="${imageUrl}" alt="${nomeEsercizio}" class="w-16 h-16 rounded-md object-cover flex-shrink-0 cursor-pointer enlargeable-image" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ef4444/ffffff?text=Error';">
                            <div class="flex-grow text-center sm:text-left">
                                <p class="font-bold text-lg text-slate-100">${nomeEsercizio}</p>
                                <p class="text-slate-400 font-mono text-sm">
                                    ${esercizio.serie || '-'} x ${esercizio.ripetizioni || '-'} @ ${esercizio.percentuale || '-'}%
                                </p>
                            </div>
                            <div class="flex items-center gap-3 bg-slate-700 p-3 rounded-lg sm:ml-auto">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><rect x="3" y="10" width="4" height="4" rx="1"/><rect x="17" y="10" width="4" height="4" rx="1"/><line x1="7" y1="12" x2="17" y2="12"/></svg>
                                <p class="text-xl font-bold text-white">${pesoCalcolato} kg</p>
                            </div>
                        </div>
                    `;
                });
            } else {
                exerciseList.innerHTML = `<p class="text-slate-400">Nessun esercizio in questa scheda.</p>`;
            }

            content.appendChild(exerciseList);
            details.appendChild(summary);
            details.appendChild(content);
            return details;
        }

        // --- GESTIONE LIGHTBOX IMMAGINE ---

        function openImageLightbox(src) {
            lightboxImage.src = src;
            imageLightbox.classList.remove('hidden');
            setTimeout(() => imageLightbox.classList.remove('opacity-0'), 10); // Fade in
        }
        
        function closeImageLightbox() {
            imageLightbox.classList.add('opacity-0');
            setTimeout(() => {
                imageLightbox.classList.add('hidden');
                lightboxImage.src = ''; // Pulisce l'immagine per evitare flash
            }, 300);
        }

        // Usa event delegation sul container principale
        mainContent.addEventListener('click', (e) => {
            if (e.target.classList.contains('enlargeable-image')) {
                openImageLightbox(e.target.src);
            }
        });

        closeLightboxBtn.addEventListener('click', closeImageLightbox);
        imageLightbox.addEventListener('click', (e) => {
            // Chiude solo se si clicca sullo sfondo e non sull'immagine o sul bottone
            if (e.target === imageLightbox) { 
                closeImageLightbox();
            }
        });

    </script>
</body>
</html>
